#!/usr/bin/env python3

import csv, re, os

delm = '\t'
outputDirPrefix = 'output/'
inputVulnMethods = 'Results v2/VulnerableMethods.csv'
inputCodeMetricData = 'metricdata/base-android-6.0.0_r41-metrics.csv'
inputCodeNanopatternData = 'metricdata/base-android-6.0.0_r41-nanopatterns-ex1.csv'
outputVulnMethodData = 'VulnerableMethodsMetrics.csv'
outputNutMethodData = 'NeutralMethodsMetrics.csv'

os.makedirs(os.path.dirname(outputDirPrefix), exist_ok=True)

# Read in the list of vuln methods
vulnMethods = set()
with open(inputVulnMethods,'r') as f:
    next(f) # skip headings
    reader=csv.reader(f,delimiter='\t')
    for csvCve, csvCommit, csvFileName, csvMethodName in reader:
        #print(csvFileName)
        m = re.search(r"((?<=\/java\/)|(?<=\/src\/))(.*?)(?=(\.java))", csvFileName)
        if not m:
            continue
        classPath = m.group(0).replace('/', '.')
        methodPath = classPath + '.' + csvMethodName
        vulnMethods.add(methodPath)

vulnMethodsData = dict()
nutMethodsData = dict()

hasMetricData = set()
hasNanopatternData = set()

# Read the metrics data
i = 0
with open(inputCodeMetricData,'r') as f:
    next(f) # skip headings
    reader=csv.reader(f,delimiter=',')
    for Kind,Name,CountLine,CountLineCode,CountOutput,CountPath,Cyclomatic,CyclomaticModified,CyclomaticStrict,Essential,MaxNesting in reader:
        if 'Method' in str(Kind):
            if '.manymethods' in Name:
                continue
            if 'android' not in Name:
                continue
            i += 1
            metrics = [CountLine,CountLineCode,CountOutput,CountPath,Cyclomatic,CyclomaticModified,CyclomaticStrict,Essential,MaxNesting]
            if Name not in hasMetricData:
                if Name in vulnMethods:
                    vulnMethodsData[Name] = ','.join(metrics)
                else:
                    nutMethodsData[Name] = ','.join(metrics)
                hasMetricData.add(Name)

print("Total metric data CSV lines processed: {}".format(i))
print("Num vuln methodds: {} ".format(len(vulnMethods)))
print("Num vuln methods with metric data: {}".format(len(vulnMethodsData)))
print("Num non-vuln methods with data: {}".format(len(nutMethodsData)))

# Read the nanopatterns data
i = 0
noMatchingMetrics = 0
with open(inputCodeNanopatternData,'r') as f:
    next(f) # skip headings
    reader=csv.reader(f,delimiter=',')
    for csvclass,method,typesignature,version,numInstrs,noparams,void,recursive,samename,leaf,objCreator,thisInstanceFieldReader,thisInstanceFieldWriter,otherInstanceFieldReader,otherInstanceFieldWriter,staticFieldReader,staticFieldWriter,typeManipulator,straightLine,looper,switcher,exceptions,localReader,localWriter,arrCreator,arrReader,arrWriter,polymorphic,singleReturner,multipleReturner,client,jdkClient,tailCaller in reader:
        if ('/manymethods' in csvclass) or ('$' in csvclass):
            continue
        if 'android' not in csvclass:
            continue
        if str(method).startswith('<'):
            continue
        i += 1
        methodpath = csvclass.replace('/', '.') + '.' + method
        metrics = [numInstrs,noparams,void,recursive,samename,leaf,objCreator,thisInstanceFieldReader,thisInstanceFieldWriter,otherInstanceFieldReader,otherInstanceFieldWriter,staticFieldReader,staticFieldWriter,typeManipulator,straightLine,looper,switcher,exceptions,localReader,localWriter,arrCreator,arrReader,arrWriter,polymorphic,singleReturner,multipleReturner,client,jdkClient,tailCaller]
        if methodpath not in hasNanopatternData:
            if methodpath in vulnMethodsData:
                vulnMethodsData[methodpath] += ',' + ','.join(metrics)
            elif methodpath in nutMethodsData:
                nutMethodsData[methodpath] += ',' + ','.join(metrics)
            else:
                noMatchingMetrics += 1
            hasNanopatternData.add(methodpath)

print("Total nanopattern data CSV lines processed: {}".format(i))
print("Num methods in nanopattern data without matching metric data: {}".format(noMatchingMetrics))

# Write out the data
csvHeader = "method,CountLine,CountLineCode,CountOutput,CountPath,Cyclomatic,CyclomaticModified,CyclomaticStrict,Essential,MaxNesting,numInstrs,noparams,void,recursive,samename,leaf,objCreator,thisInstanceFieldReader,thisInstanceFieldWriter,otherInstanceFieldReader,otherInstanceFieldWriter,staticFieldReader,staticFieldWriter,typeManipulator,straightLine,looper,switcher,exceptions,localReader,localWriter,arrCreator,arrReader,arrWriter,polymorphic,singleReturner,multipleReturner,client,jdkClient,tailCaller"
nanopatternDataFiller = ",,,,,,,,,,,,,,,,,,,,,,,,,,,,,"
numMethodsNoNanopatternData = 0

outputFile = open(outputDirPrefix + outputVulnMethodData, "w")
outputFile.write(csvHeader + '\n')
for key, value in vulnMethodsData.items():
    filler = ""
    if key not in hasNanopatternData:
        numMethodsNoNanopatternData += 1
        filler = nanopatternDataFiller
    outputFile.write(key + ',' + value + '\n')
outputFile.close()

outputFile = open(outputDirPrefix + outputNutMethodData, "w")
outputFile.write(csvHeader + '\n')
for key, value in nutMethodsData.items():
    filler = ""
    if key not in hasNanopatternData:
        numMethodsNoNanopatternData += 1
        filler = nanopatternDataFiller
    outputFile.write(key + ',' + value + filler + '\n')
outputFile.close()

print("Total methods missing nanopattern data: {}".format(numMethodsNoNanopatternData))
