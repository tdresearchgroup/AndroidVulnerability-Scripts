#!/usr/bin/env python3

import csv
import subprocess, sys, re
import os, time

delm = '\t'
outputDirPrefix = 'output/'
csvInputFilename = 'AndroidCveCommitDataJava.csv'
csvOutputFilename = 'VulnerableMethods.csv'
statsOutputFilename = 'VulnerableMethods-stats.txt'
localGitRepoFilepath = '/Users/charles/Documents/DIS/base'
repoName = '/platform/frameworks/base/'

if not os.path.isdir(localGitRepoFilepath + "/.git"):
    print("Error: Could not find local Git repo directly under {}".format(localGitRepoFilepath))
    print("You must clone the target repo locally and specify the path in the script so the commit diffs can be read.")
    print("Exiting.")
    exit(1)

os.makedirs(os.path.dirname(outputDirPrefix), exist_ok=True)

outputFile = open(outputDirPrefix + csvOutputFilename, "w")
outputFile.write("CVE\tCommit Hash\tFile Name\tMethod Name\n")

print("Starting extraction of vulnerable methods from {}...".format(repoName))
filecount = 0
methodcount = 0
totalcommitcount = 0
releventcommitcount = 0
vulMethods = set()
vulClasses = set()
with open(outputDirPrefix + csvInputFilename,'r') as f:
    next(f) # skip headings
    reader=csv.reader(f,delimiter='\t')
    for csvRelevant, csvBulletinMonth, csvCve, csvSeverite, csvVersions, csvCommitUrls, csvExternalRepo, csvRepo, csvFiles in reader:
        # Focused only on one repo for now
        if csvRepo == repoName:
            csvCommitUrlsArr = csvCommitUrls.split(', ')
            for commitUrl in csvCommitUrlsArr:
                totalcommitcount += 1
                commitHash = commitUrl.split('/+/')[1]

                command = r"git \
                --git-dir={}/.git --work-tree={} \
                diff -U0 {}^! | \
                grep -E '^(@@)|(diff \-\-git)' | \
                grep -E '(\()|(^diff \-\-git)' | \
                sed 's/@@.*@@//' | \
                sed 's/(.*//' | \
                uniq".format(localGitRepoFilepath, localGitRepoFilepath, commitHash)

                result = subprocess.check_output(command, shell=True).decode(sys.stdout.encoding)

                commitHasReleventData = False
                resultsPerFile = result.split('diff --git')
                for fileResult in resultsPerFile:
                    resultLines = fileResult.split('\n')
                    if len(resultLines) < 3:
                        continue
                    m = re.search(r"(?<=(a\/)|(b\/))(.*?)(?=( )|(\n)|$)", resultLines[0])
                    if not m:
                        continue
                    filename = m.group(0)
                    print(filename)
                    filecount += 1
                    for methodSignature in resultLines[1:]:
                        if len(methodSignature) <= 1:
                            continue
                        methodName = methodSignature.split(' ')[-1]
                        print(" ", methodName)
                        methodcount += 1
                        commitHasReleventData = True
                        vulClasses.add(filename)
                        vulMethods.add(filename + "\t" + methodName)
                        outputFile.write(csvCve + "\t" + commitHash + "\t" + filename + "\t" + methodName + "\n")
                    
                if commitHasReleventData:
                    releventcommitcount += 1

outputFile.close()

stats = "Generated at " + time.strftime('%l:%M%p %Z on %b %d, %Y') + "\n"
stats += "\n"
stats += "Target repo name: " + repoName + "\n"
stats += "Path to Git repo locally: " + localGitRepoFilepath + "\n"
stats += "\n"
stats += "Commits with relevent data: {}/{}".format(releventcommitcount, totalcommitcount) + "\n"
stats += "CSV Output: Lists {} \"vulnerable\" methods (non-unique) found in {} classes (non-unique)".format(methodcount, filecount) + "\n"
stats += "Numver of \"vulnerable\" methods (unique): {} ".format(len(vulMethods)) + "\n"
stats += "Numver of \"vulnerable\" classes (unique): {} ".format(len(vulClasses)) + "\n"

outputFileStats = open(outputDirPrefix + statsOutputFilename, "w")
outputFileStats.write(stats)
outputFileStats.close()

print("\nExtraction complete.\n")
print(stats)
