#!/usr/bin/env python3

import re
import requests
from datetime import datetime
import time
import os

delm = '\t'
outputDirPrefix = 'output/'
csvOutputFilename = 'AndroidCveCommitDataJava.csv'
classListingOutputFilename = 'AndroidVulnerableClassesList.txt'
statsOutputFilename = 'AndroidCveCommitDataJava-stats.txt'
startYear = 2015
startMonth = 8
endYear = int(datetime.now().year)
endMonth = int(datetime.now().month)

print("Getting Android vulnerability data from {}/{} to {}/{}...".format(startMonth,startYear,endMonth,endYear))

bulletinMonths = []
orgStartYear = startYear
orgStartMonth = startMonth
while startYear <= endYear and (startMonth <= endMonth or startYear < endYear):
    if startMonth == 13:
        startMonth = 1
        startYear += 1
    bulletinMonths.append(str(startYear) + "-" + str(startMonth).zfill(2) + "-01")
    startMonth += 1

os.makedirs(os.path.dirname(outputDirPrefix), exist_ok=True)

outputFile = open(outputDirPrefix + csvOutputFilename, "w")
outputData = "Relevant?" + delm + "Bulletin Month"+delm+"CVE Identifier"+delm+"Severity"+delm+"Affected Versions"+delm+\
             "Commit URL(s)"+delm+"External Repository?"+delm+"Repository Prefix"+delm + "Files"+"\n"
print(outputData)
outputFile.write(outputData)
outputData = ""

totalNumberOfVuls = 0
numberOfReleventVuls = 0
allVulClasses = set()
baseBulletinUrl = "https://source.android.com/security/bulletin/"

for month in bulletinMonths:
    html = requests.get(baseBulletinUrl + month).text
    possibleTables = html.split("<table>")
    for table in possibleTables:
        if "<th>CVE</th>" in table:
            possibleRows = table.split("<tr>")
            refCol = 0
            severityCol = 0
            affectedCol = 0
            for row in possibleRows:
                if "<th>CVE</th>" in row:
                    cells = row.split("<th>")
                    colIndex = 0
                    for cell in cells:
                        if "references" in cell.lower() or "bug" in cell.lower():
                            refCol = colIndex
                        elif "severity" in cell.lower():
                            severityCol = colIndex
                        elif "versions" in cell.lower():
                            affectedCol = colIndex
                        colIndex += 1
                elif "<td>CVE-" in row:
                    cells = row.split("<td>")
                    cveId = cells[1].split("</td>")[0]
                    urls = ""
                    urlList = []
                    if severityCol != 0:
                        commitData = cells[refCol]
                        try:
                            urlList = re.findall("href=\"(.*?)\"", commitData)
                            urls = ", ".join(urlList)
                        except AttributeError:
                            urls = ""
                    severity = ""
                    if severityCol != 0:
                        severity = cells[severityCol].split("</td>")[0]
                    affected = ""
                    if affectedCol != 0:
                        affected = cells[affectedCol].split("</td>")[0]
                    urlRelevantBool = urls!="" and ("android.googlesource.com" in urls)
                    if not urlRelevantBool:
                        continue
                    filesList = []
                    repo = ""
                    hasJavaFile = False
                    thirdPartyRepoBool = False
                    for url in urlList:
                        if str(url).startswith("//"):
                            url = "https:" + url
                        commitHtml = requests.get(url).text
                        try:
                            filesHtml = re.search('<ul class=\"DiffTree\">(.*?)</ul>', commitHtml).group(1)
                        except AttributeError:
                            continue
                        newFiles = re.findall("\">(?!\[)(?!diff)(.+?)</a>", filesHtml)
                        try:
                            repoOfUrl = re.search('android\.googlesource\.com(.*?)\+/', url).group(1).replace("%2F", "/")
                        except AttributeError:
                            repo = ""
                        if "/external/" in repoOfUrl:
                            thirdPartyRepoBool = True
                        if repo != "" and repo != repoOfUrl:
                            repo = "(multiple)"
                        else:
                            repo = repoOfUrl
                        for filename in newFiles:
                            if filename.endswith(".java") and ("/test/" not in filename):
                                hasJavaFile = True
                                filesList.append(filename)
                                allVulClasses.add(repoOfUrl+filename)
                    filesStr = ", ".join(filesList)
                    totalNumberOfVuls += 1
                    if urlRelevantBool and hasJavaFile:
                        numberOfReleventVuls += 1
                        relevantStr = "true"
                    else:
                        relevantStr = "false"
                    thirdPartyRepoStr = "true" if thirdPartyRepoBool else "false"
                    newLine = relevantStr + delm + month + delm + cveId + delm + severity + delm + affected + delm + \
                              urls + delm + thirdPartyRepoStr + delm + repo + delm + filesStr+"\n"
                    print(newLine)
                    if not hasJavaFile:
                        continue
                    outputData += newLine
    outputFile.write(outputData)
    outputData = ""

outputFile.close()

outputFile2 = open(outputDirPrefix + classListingOutputFilename, "w")
outputFile2.write("\n".join(allVulClasses))
outputFile2.close()

stats = "Generated at " + time.strftime('%l:%M%p %Z on %b %d, %Y') + "\n"
stats += "Covers data from {}/{} to {}/{}".format(orgStartMonth,orgStartYear,endMonth,endYear) + "\n"
stats += "Data collected form: " + baseBulletinUrl + "\n"
stats += "\n"
stats += "Total number vulnerabilities (any language): " + str(totalNumberOfVuls) + "\n"
stats += "Number of Java-related vulnerabilities (\"relevent\" vulnerabilities): " + str(numberOfReleventVuls) + "\n"
stats += "Number \"vulnerable\" Java classes: " + str(len(allVulClasses)) + "\n"

outputFile3 = open(outputDirPrefix + statsOutputFilename, "w")
outputFile3.write(stats)
outputFile3.close()

print("\nDone.\n")
print(stats)
